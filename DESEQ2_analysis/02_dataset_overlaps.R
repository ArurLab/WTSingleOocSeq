### 
#   This script requires the following:
#     1) some data generated by the file deseq2_analysis.R. That file should be run before this file.
#     2) the supplemental data from the related studies which were compared. Details below.
#     3) For the Tintori et al dataset, generation of wormbase IDs using wormbase's gene name sanitizer. Details below
#     4) Installation of the "VennDiagram" R package
###

# Convert our study's cpm data to a data frame
cpm_df <- data.frame(cpm)

# Generate list of all genes with an average >= 1cpm across oocyte positions
ocyts.cpm <- cpm_df
ocyts.cpm$avg <- apply(ocyts.cpm,1,mean)
ocyts.avg.1cpm <- ocyts.cpm[ocyts.cpm$avg >= 1,]
ocyts.avg.1cpm.list <- rownames(ocyts.avg.1cpm)

### Comparisons with stoeckius et al ###

# Read in data from stoeckius et al
# This file can be found in their supplement
stoeckius <- read.csv("stoeckius et al supp table 1.csv",)


# Generate list of detected genes from stoeckius et al in oocytes
stoeckius_ocyt_detected <- stoeckius[stoeckius$oocyte_rpkm >= 2,]
stoeckius_detect.ocyt.wblist <- stoeckius_ocyt_detected$GENEWBID


# Generate list of detected genes from stoeckius et al in 1 cell embryo
stoeckius_x1cell_detected <- stoeckius[stoeckius$X1cell_rpkm >= 2,]
stoeckius_detect.x1cell.wblist <- stoeckius_x1cell_detected$GENEWBID

# Compare all oocytes to stoeckius oocyte  list
ocyts.stoeckius_ocyt.avg.intersect <- intersect(ocyts.avg.1cpm.list, stoeckius_detect.ocyt.wblist)
ocyts.stoeckius_ocyt.overlap <- length(ocyts.stoeckius_ocyt.avg.intersect)/min(length(ocyts.avg.1cpm.list), length(stoeckius_detect.ocyt.wblist))

# Compare all oocytes to stoeckius 1 cell embryo list
ocyts.stoeckius_1cell.avg.intersect <- intersect(ocyts.avg.1cpm.list, stoeckius_detect.x1cell.wblist)
ocyts.stoeckius_1cell.overlap <- length(ocyts.stoeckius_1cell.avg.intersect)/min(length(ocyts.avg.1cpm.list), length(stoeckius_detect.x1cell.wblist))


# Convert Tintori et al. data into a csv first!!
# Read in data from Tintori et al as a csv file
tintori_all <- read.csv("TableS2_RPKMs.csv")

# Isolate the valid 1 cell data
valid_1_cell_entries <- c('st411', 'st413', 'st441', 'st449', 'st451')
tintori_1cell <- tintori_all[,1]
tintori_1cell <- cbind(tintori_1cell, subset(tintori_all, select=valid_1_cell_entries))

# Replicate analysis to identify those genes with >25 RPKM
tintori_1cell$avg <- apply(tintori_1cell[,c(2, 3, 4, 5, 6)], 1, mean)
tintori_1cell_avg <- tintori_1cell[tintori_1cell$avg > 25,]
tintori_1cell_avg_list <- tintori_1cell_avg[,1]

## Since the tintori dataset uses gene names, and gene names can change, 
## the gene names should be converted to wormbase gene ID numbers for the comparison

# Write 1cell detected genes to text file with one gene per line
write(paste(tintori_1cell_avg_list, sep="\n"), file="tintori_1cell_detected_genes.txt")

# Use the wormbase gene sanitizer to transform the gene names into WBGene numbers (https://wormbase.org/tools/mine/gene_sanitizer.cgi)
# Read in the tsv output file (filename should be changed to match the filename from the gene sanitizer)
tintori_1cell_avg_wb_df <- read.csv("gene_name_sanitizer_results-tintori_all.txt", sep="\t")

# Get the wormbase IDs from the Suggested match column
tintori_1cell_avg_wb_list <- tintori_1cell_avg_wb_df$Suggested.Match

# Determine overlap between all oocyte list and tintori list
ocyts.tintori_1cell.intersect = intersect(tintori_1cell_avg_wb_list, ocyts.avg.1cpm.list)
ocyts.tintori_1cell.overlap <- length(ocyts.tintori_1cell.intersect)/min(length(tintori_1cell_avg_list), length(ocyts.avg.1cpm.list))


### Create proportional venn diagrams for the overlaps
library("VennDiagram")

# Tintori et al 1 cell embryo
a = length(ocyts.avg.1cpm.list)
b = length(tintori_1cell_avg_wb_list)
ab = length(ocyts.tintori_1cell.intersect)
grid.newpage()
draw.pairwise.venn(area1=a, area2=b, cross.area=ab)

# Stoeckius oocyte
a = length(ocyts.avg.1cpm.list)
b = length(stoeckius_detect.ocyt.wblist)
ab = length(ocyts.stoeckius_ocyt.avg.intersect)
grid.newpage()
draw.pairwise.venn(area1=a, area2=b, cross.area=ab)

# Stoeckius 1 cell embryo
a = length(ocyts.avg.1cpm.list)
b = length(stoeckius_detect.x1cell.wblist)
ab = length(ocyts.stoeckius_1cell.avg.intersect)
grid.newpage()
draw.pairwise.venn(area1=a, area2=b, cross.area=ab)
